<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单播放器测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .video-container {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
            margin: 10px 0;
            position: relative;
        }
        video {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        .controls {
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #74c0fc; }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LibreTV 简单播放器测试</h1>
        
        <div class="test-section">
            <h2>1. 基础HTML5视频播放测试</h2>
            <div class="video-container">
                <video id="basicVideo" controls>
                    <source src="" type="video/mp4">
                    您的浏览器不支持视频播放。
                </video>
            </div>
            <div class="controls">
                <input type="text" id="basicVideoUrl" placeholder="输入视频URL (支持mp4, m3u8等格式)">
                <button onclick="testBasicVideo()">测试基础播放</button>
                <button onclick="testSampleVideo()">测试示例视频</button>
            </div>
        </div>

        <div class="test-section">
            <h2>2. HLS.js播放测试</h2>
            <div class="video-container">
                <video id="hlsVideo" controls></video>
            </div>
            <div class="controls">
                <input type="text" id="hlsVideoUrl" placeholder="输入HLS视频URL (.m3u8格式)">
                <button onclick="testHlsVideo()">测试HLS播放</button>
                <button onclick="testSampleHls()">测试示例HLS</button>
            </div>
        </div>

        <div class="test-section">
            <h2>3. ArtPlayer播放测试</h2>
            <div id="artplayer" class="video-container"></div>
            <div class="controls">
                <input type="text" id="artVideoUrl" placeholder="输入视频URL">
                <button onclick="testArtPlayer()">测试ArtPlayer</button>
                <button onclick="destroyArtPlayer()">销毁播放器</button>
            </div>
        </div>

        <div class="test-section">
            <h2>测试日志</h2>
            <div id="testLog" class="log"></div>
            <button onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <!-- 引入必要的库 -->
    <script src="libs/hls.min.js"></script>
    <script src="libs/artplayer.min.js"></script>

    <script>
        let artInstance = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        // 测试基础HTML5视频播放
        function testBasicVideo() {
            const video = document.getElementById('basicVideo');
            const url = document.getElementById('basicVideoUrl').value.trim();
            
            if (!url) {
                log('请输入视频URL', 'error');
                return;
            }
            
            log(`开始测试基础视频播放: ${url}`);
            
            video.src = url;
            video.load();
            
            video.addEventListener('loadstart', () => log('视频开始加载', 'info'));
            video.addEventListener('canplay', () => log('视频可以播放', 'success'));
            video.addEventListener('error', (e) => {
                log(`视频播放错误: ${e.target.error?.message || '未知错误'}`, 'error');
            });
            
            video.play().then(() => {
                log('视频播放成功', 'success');
            }).catch(e => {
                log(`视频播放失败: ${e.message}`, 'error');
            });
        }

        // 测试示例视频
        function testSampleVideo() {
            document.getElementById('basicVideoUrl').value = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';
            testBasicVideo();
        }

        // 测试HLS视频播放
        function testHlsVideo() {
            const video = document.getElementById('hlsVideo');
            const url = document.getElementById('hlsVideoUrl').value.trim();
            
            if (!url) {
                log('请输入HLS视频URL', 'error');
                return;
            }
            
            log(`开始测试HLS视频播放: ${url}`);
            
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    log('HLS清单解析成功', 'success');
                    video.play().then(() => {
                        log('HLS视频播放成功', 'success');
                    }).catch(e => {
                        log(`HLS视频播放失败: ${e.message}`, 'error');
                    });
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    log(`HLS错误: ${data.type} - ${data.details}`, 'error');
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('canplay', () => {
                    log('原生HLS支持，视频可以播放', 'success');
                });
                video.play();
            } else {
                log('浏览器不支持HLS播放', 'error');
            }
        }

        // 测试示例HLS
        function testSampleHls() {
            document.getElementById('hlsVideoUrl').value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
            testHlsVideo();
        }

        // 测试ArtPlayer
        function testArtPlayer() {
            const url = document.getElementById('artVideoUrl').value.trim();
            
            if (!url) {
                log('请输入视频URL', 'error');
                return;
            }
            
            log(`开始测试ArtPlayer播放: ${url}`);
            
            // 销毁旧实例
            if (artInstance) {
                artInstance.destroy();
                artInstance = null;
            }
            
            try {
                artInstance = new Artplayer({
                    container: '#artplayer',
                    url: url,
                    type: url.includes('.m3u8') ? 'm3u8' : 'auto',
                    title: '测试视频',
                    volume: 0.8,
                    autoplay: true,
                    pip: true,
                    setting: true,
                    fullscreen: true,
                    customType: {
                        m3u8: function (video, url) {
                            if (Hls.isSupported()) {
                                const hls = new Hls();
                                hls.loadSource(url);
                                hls.attachMedia(video);
                                
                                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                    log('ArtPlayer HLS清单解析成功', 'success');
                                });
                                
                                hls.on(Hls.Events.ERROR, (event, data) => {
                                    log(`ArtPlayer HLS错误: ${data.details}`, 'error');
                                });
                            } else {
                                video.src = url;
                            }
                        }
                    }
                });
                
                artInstance.on('ready', () => {
                    log('ArtPlayer初始化成功', 'success');
                });
                
                artInstance.on('video:error', (error) => {
                    log(`ArtPlayer视频错误: ${error.message || '未知错误'}`, 'error');
                });
                
                artInstance.on('video:canplay', () => {
                    log('ArtPlayer视频可以播放', 'success');
                });
                
            } catch (e) {
                log(`ArtPlayer初始化失败: ${e.message}`, 'error');
            }
        }

        // 销毁ArtPlayer
        function destroyArtPlayer() {
            if (artInstance) {
                artInstance.destroy();
                artInstance = null;
                log('ArtPlayer已销毁', 'info');
            }
        }

        // 页面加载完成后的初始化
        window.addEventListener('load', () => {
            log('页面加载完成，开始环境检测', 'info');
            
            // 检测库是否加载
            if (typeof Hls !== 'undefined') {
                log('HLS.js库加载成功', 'success');
            } else {
                log('HLS.js库加载失败', 'error');
            }
            
            if (typeof Artplayer !== 'undefined') {
                log('ArtPlayer库加载成功', 'success');
            } else {
                log('ArtPlayer库加载失败', 'error');
            }
            
            // 检测浏览器支持
            const video = document.createElement('video');
            if (video.canPlayType('video/mp4')) {
                log('浏览器支持MP4格式', 'success');
            }
            if (video.canPlayType('application/vnd.apple.mpegurl')) {
                log('浏览器原生支持HLS', 'success');
            }
            
            log('环境检测完成，可以开始测试', 'info');
        });

        // 全局错误捕获
        window.addEventListener('error', (e) => {
            log(`全局错误: ${e.message} (${e.filename}:${e.lineno})`, 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`未处理的Promise拒绝: ${e.reason}`, 'error');
        });
    </script>
</body>
</html>