# Tesla LibreTV 部署和使用指南

## 📋 概述

本指南将帮助您部署和使用Tesla LibreTV完整测试套件，该套件包含WebRTC实时流媒体、代理服务器、性能监控和智能降级等多种视频播放解决方案。

## 🚀 快速开始

### 1. 环境要求

- **Node.js**: 版本 14.0 或更高
- **FFmpeg**: 用于视频转码（可选）
- **现代浏览器**: 支持WebRTC和ES6+
- **网络**: 稳定的互联网连接

### 2. 项目结构

```
LibreTV/
├── server/                          # 代理服务器
│   ├── tesla-proxy-server.js        # 代理服务器主文件
│   ├── package.json                 # 服务器依赖
│   └── cache/                       # 视频缓存目录
├── js/                              # 客户端JavaScript
│   ├── tesla-webrtc-player.js       # WebRTC播放器
│   ├── tesla-proxy-client.js        # 代理客户端
│   ├── tesla-performance-monitor.js # 性能监控
│   └── tesla-fallback-manager.js    # 智能降级管理
├── tesla-complete-test-suite.html   # 完整测试套件
├── tesla-optimization.json          # 优化配置
└── DEPLOYMENT_GUIDE.md             # 本指南
```

## 🔧 安装和配置

### 步骤1: 安装服务器依赖

```bash
# 进入服务器目录
cd server

# 安装依赖
npm install
```

### 步骤2: 启动代理服务器

```bash
# 在server目录下启动服务器
node tesla-proxy-server.js
```

服务器将在 `http://localhost:3001` 启动。

### 步骤3: 配置FFmpeg（可选）

如果需要视频转码功能，请安装FFmpeg：

**Windows:**
```bash
# 使用Chocolatey
choco install ffmpeg

# 或下载预编译版本
# https://ffmpeg.org/download.html
```

**macOS:**
```bash
# 使用Homebrew
brew install ffmpeg
```

**Linux:**
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ffmpeg

# CentOS/RHEL
sudo yum install ffmpeg
```

## 🎮 使用测试套件

### 1. 打开测试页面

在浏览器中打开 `tesla-complete-test-suite.html`

### 2. 测试功能模块

#### WebRTC实时流媒体

1. **配置信令服务器**:
   - 默认: `ws://localhost:8080/signal`
   - 如果没有信令服务器，WebRTC功能将受限

2. **设置视频源**:
   - 支持HTTP/HTTPS视频URL
   - 推荐使用公开的测试视频

3. **开始测试**:
   - 点击"🚀 测试WebRTC"
   - 观察连接状态和播放效果

#### 代理服务器播放

1. **确认服务器运行**:
   - 代理服务器地址: `http://localhost:3001`
   - 检查服务器状态指示器

2. **选择播放模式**:
   - **代理模式**: 直接代理原始视频
   - **转码模式**: 转码为Tesla优化格式
   - **流媒体模式**: 实时流媒体传输

3. **开始测试**:
   - 点击"🚀 测试代理"
   - 观察不同模式的播放效果

#### 性能监控

1. **配置监控参数**:
   - 监控间隔: 1000ms（推荐）
   - 优化间隔: 10000ms（推荐）

2. **启动监控**:
   - 点击"📈 开始监控"
   - 观察实时性能指标

3. **性能指标说明**:
   - **带宽**: 当前网络带宽使用
   - **帧率**: 视频播放帧率
   - **延迟**: 播放延迟
   - **CPU**: CPU使用率
   - **内存**: 内存使用率
   - **总体评分**: 综合性能评分

#### 智能降级测试

1. **选择降级策略**:
   - **自动选择**: 根据环境自动选择最佳方案
   - **质量优先**: 优先保证视频质量
   - **速度优先**: 优先保证播放流畅性
   - **兼容性优先**: 优先保证设备兼容性

2. **开始智能播放**:
   - 点击"🧠 智能播放"
   - 系统将自动尝试多种播放方案
   - 观察降级过程和最终选择的方案

## 🔍 故障排除

### 常见问题

#### 1. 代理服务器无法启动

**症状**: 服务器启动失败或端口被占用

**解决方案**:
```bash
# 检查端口占用
netstat -ano | findstr :3001

# 杀死占用进程（Windows）
taskkill /PID <PID> /F

# 或更改服务器端口
# 编辑 tesla-proxy-server.js，修改 PORT 变量
```

#### 2. WebRTC连接失败

**症状**: WebRTC无法建立连接

**解决方案**:
- 检查信令服务器是否运行
- 确认防火墙设置
- 尝试使用HTTPS协议
- 检查浏览器WebRTC支持

#### 3. 视频无法播放

**症状**: 视频加载失败或播放卡顿

**解决方案**:
- 检查视频URL是否有效
- 确认网络连接稳定
- 尝试不同的播放模式
- 检查浏览器控制台错误信息

#### 4. 性能监控数据异常

**症状**: 性能指标显示异常值

**解决方案**:
- 重置性能指标
- 检查监控间隔设置
- 确认视频正在播放
- 重启性能监控

### 调试技巧

#### 1. 启用详细日志

在测试套件中，所有组件都支持调试模式：

```javascript
// 在浏览器控制台中启用调试
localStorage.setItem('tesla-debug', 'true');

// 重新加载页面以应用设置
location.reload();
```

#### 2. 检查网络请求

使用浏览器开发者工具的网络标签页：
- 检查代理请求是否成功
- 查看视频加载状态
- 分析网络延迟和带宽

#### 3. 监控系统资源

使用系统监控工具：
- Windows: 任务管理器
- macOS: 活动监视器
- Linux: htop 或 top

## 🚗 Tesla车机特殊配置

### 网络配置

1. **WiFi连接**:
   - 确保车辆连接到稳定的WiFi网络
   - 避免使用移动热点（带宽限制）

2. **代理设置**:
   - 如果需要，配置HTTP代理
   - 确保代理服务器可访问

### 浏览器优化

1. **缓存设置**:
   - 清理浏览器缓存
   - 禁用不必要的扩展

2. **性能优化**:
   - 关闭其他标签页
   - 降低视频质量设置

### 推荐测试流程

1. **连接性测试**:
   - 首先测试代理服务器连接
   - 验证网络带宽和延迟

2. **功能测试**:
   - 按优先级测试各种播放方案
   - 记录每种方案的表现

3. **性能测试**:
   - 启动性能监控
   - 测试长时间播放稳定性

4. **智能降级测试**:
   - 测试自动降级功能
   - 验证降级策略的有效性

## 📊 性能优化建议

### 网络优化

1. **带宽管理**:
   - 根据网络条件调整视频质量
   - 使用自适应比特率流

2. **缓存策略**:
   - 启用视频预缓存
   - 合理设置缓存大小

### 系统优化

1. **资源管理**:
   - 监控CPU和内存使用
   - 及时释放不必要的资源

2. **并发控制**:
   - 限制同时播放的视频数量
   - 优化线程池配置

## 🔒 安全注意事项

### 网络安全

1. **HTTPS使用**:
   - 生产环境中使用HTTPS
   - 配置SSL证书

2. **访问控制**:
   - 限制代理服务器访问
   - 实施IP白名单

### 数据保护

1. **缓存管理**:
   - 定期清理缓存文件
   - 避免缓存敏感内容

2. **日志安全**:
   - 避免记录敏感信息
   - 定期轮转日志文件

## 📞 技术支持

### 日志收集

在报告问题时，请提供以下信息：

1. **系统信息**:
   - 操作系统版本
   - 浏览器版本
   - Node.js版本

2. **错误日志**:
   - 浏览器控制台错误
   - 服务器日志
   - 网络请求详情

3. **重现步骤**:
   - 详细的操作步骤
   - 预期结果和实际结果
   - 环境配置信息

### 性能报告

使用测试套件的导出功能：

1. 点击"💾 导出日志"按钮
2. 保存性能监控数据
3. 记录测试环境信息

## 🔄 更新和维护

### 定期维护

1. **依赖更新**:
   ```bash
   # 检查过时的依赖
   npm outdated
   
   # 更新依赖
   npm update
   ```

2. **缓存清理**:
   ```bash
   # 清理服务器缓存
   rm -rf server/cache/*
   ```

3. **日志轮转**:
   - 定期备份和清理日志文件
   - 监控磁盘空间使用

### 功能扩展

1. **添加新的播放方案**:
   - 在 `tesla-fallback-manager.js` 中添加新方法
   - 更新测试套件界面

2. **自定义优化策略**:
   - 修改 `tesla-optimization.json` 配置
   - 实现自定义优化算法

---

## 📝 总结

本部署指南涵盖了Tesla LibreTV测试套件的完整部署和使用流程。通过遵循本指南，您可以：

- ✅ 成功部署所有组件
- ✅ 进行全面的功能测试
- ✅ 监控和优化播放性能
- ✅ 处理常见问题和故障
- ✅ 为Tesla车机环境做好准备

如果在使用过程中遇到问题，请参考故障排除部分或收集详细的日志信息以便进一步分析。